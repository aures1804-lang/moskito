Carpeta Backend\app

__init__.py

from flask import Flask
from flask_sqlalchemy import SQLAlchemy

db = SQLAlchemy()



models.py


from run import db
from datetime import datetime

class Caso(db.Model):
    __tablename__ = 'casos'
    
    id = db.Column(db.Integer, primary_key=True)
    sintomas = db.Column(db.JSON)
    probabilidades = db.Column(db.JSON)
    lat = db.Column(db.Float, nullable=False)
    lon = db.Column(db.Float, nullable=False)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow, nullable=False)
    
    municipio = db.Column(db.String(100))
    barrio = db.Column(db.String(100))
    edad = db.Column(db.Integer)
    genero = db.Column(db.String(10))
    estado = db.Column(db.String(20), default='pendiente')
    
    def __repr__(self):
        return f'<Caso {self.id} - {self.timestamp}>'
    
    def to_dict(self):
        return {
            'id': self.id,
            'sintomas': self.sintomas,
            'probabilidades': self.probabilidades,
            'lat': self.lat,
            'lon': self.lon,
            'timestamp': self.timestamp.isoformat() if self.timestamp else None,
            'municipio': self.municipio,
            'barrio': self.barrio,
            'edad': self.edad,
            'genero': self.genero,
            'estado': self.estado
        }
    
    
routers.py

from flask import jsonify, request
from run import app, db
from app.models import Caso
from datetime import datetime

# ==================== RUTAS PRINCIPALES ====================

@app.route('/')
def home():
    return jsonify({
        "message": "ü¶ü API Moskito - Sistema de Vigilancia Epidemiol√≥gica",
        "status": "online",
        "version": "1.0",
        "endpoints": {
            "health": "/api/health",
            "docs": "/api/docs",
            "casos": "/api/casos"
        }
    })

@app.route('/api/health')
def health():
    try:
        db.session.execute(db.text('SELECT 1'))
        db_status = "connected"
        
        # Contar casos en la base de datos
        total_casos = Caso.query.count()
    except Exception as e:
        db_status = f"error: {str(e)}"
        total_casos = 0
    
    return jsonify({
        "status": "healthy",
        "database": db_status,
        "total_casos": total_casos,
        "server": "Flask",
        "timestamp": datetime.utcnow().isoformat()
    })

# ==================== CRUD DE CASOS ====================

# Listar todos los casos
@app.route('/api/casos', methods=['GET'])
def get_casos():
    try:
        # Par√°metros de filtrado opcionales
        estado = request.args.get('estado')
        municipio = request.args.get('municipio')
        limit = request.args.get('limit', 100, type=int)
        
        query = Caso.query
        
        if estado:
            query = query.filter_by(estado=estado)
        if municipio:
            query = query.filter_by(municipio=municipio)
        
        casos = query.order_by(Caso.timestamp.desc()).limit(limit).all()
        
        return jsonify({
            "success": True,
            "total": len(casos),
            "casos": [caso.to_dict() for caso in casos]
        })
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

# Obtener un caso espec√≠fico
@app.route('/api/casos/<int:caso_id>', methods=['GET'])
def get_caso(caso_id):
    try:
        caso = Caso.query.get_or_404(caso_id)
        return jsonify({
            "success": True,
            "caso": caso.to_dict()
        })
    except Exception as e:
        return jsonify({
            "success": False,
            "error": "Caso no encontrado"
        }), 404

# Crear un nuevo caso
@app.route('/api/casos', methods=['POST'])
def create_caso():
    try:
        data = request.get_json()
        
        # Validar datos requeridos
        if not data.get('sintomas') or not data.get('lat') or not data.get('lon'):
            return jsonify({
                "success": False,
                "error": "Faltan campos requeridos: sintomas, lat, lon"
            }), 400
        
        nuevo_caso = Caso(
            sintomas=data.get('sintomas'),
            probabilidades=data.get('probabilidades', {}),
            lat=data.get('lat'),
            lon=data.get('lon'),
            municipio=data.get('municipio'),
            barrio=data.get('barrio'),
            edad=data.get('edad'),
            genero=data.get('genero'),
            estado=data.get('estado', 'pendiente')
        )
        
        db.session.add(nuevo_caso)
        db.session.commit()
        
        return jsonify({
            "success": True,
            "message": "Caso creado exitosamente",
            "caso": nuevo_caso.to_dict()
        }), 201
    except Exception as e:
        db.session.rollback()
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

# Actualizar un caso
@app.route('/api/casos/<int:caso_id>', methods=['PUT'])
def update_caso(caso_id):
    try:
        caso = Caso.query.get_or_404(caso_id)
        data = request.get_json()
        
        # Actualizar campos si est√°n presentes
        if 'sintomas' in data:
            caso.sintomas = data['sintomas']
        if 'probabilidades' in data:
            caso.probabilidades = data['probabilidades']
        if 'estado' in data:
            caso.estado = data['estado']
        if 'municipio' in data:
            caso.municipio = data['municipio']
        if 'barrio' in data:
            caso.barrio = data['barrio']
        
        db.session.commit()
        
        return jsonify({
            "success": True,
            "message": "Caso actualizado exitosamente",
            "caso": caso.to_dict()
        })
    except Exception as e:
        db.session.rollback()
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

# Eliminar un caso
@app.route('/api/casos/<int:caso_id>', methods=['DELETE'])
def delete_caso(caso_id):
    try:
        caso = Caso.query.get_or_404(caso_id)
        db.session.delete(caso)
        db.session.commit()
        
        return jsonify({
            "success": True,
            "message": f"Caso {caso_id} eliminado exitosamente"
        })
    except Exception as e:
        db.session.rollback()
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

# ==================== ESTAD√çSTICAS ====================

@app.route('/api/stats', methods=['GET'])
def get_stats():
    try:
        total = Caso.query.count()
        pendientes = Caso.query.filter_by(estado='pendiente').count()
        confirmados = Caso.query.filter_by(estado='confirmado').count()
        
        # Casos por municipio
        municipios = db.session.query(
            Caso.municipio, 
            db.func.count(Caso.id)
        ).group_by(Caso.municipio).all()
        
        return jsonify({
            "success": True,
            "stats": {
                "total": total,
                "pendientes": pendientes,
                "confirmados": confirmados,
                "por_municipio": {m[0]: m[1] for m in municipios if m[0]}
            }
        })
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

# ==================== MANEJO DE ERRORES ====================

@app.errorhandler(404)
def not_found(error):
    return jsonify({
        "error": "Ruta no encontrada",
        "status": 404
    }), 404

@app.errorhandler(500)
def internal_error(error):
    return jsonify({
        "error": "Error interno del servidor",
        "status": 500
    }), 500


Carpeta venv

.env

DATABASE_URL=postgresql://vigilancia_user:Alfa$1234@localhost:5432/vigilancia_db
SQLALCHEMY_DATABASE_URI=postgresql://vigilancia_user:Alfa$1234@localhost:5432/vigilancia_db
SECRET_KEY=Alfa$1234


run.py

from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from dotenv import load_dotenv
import os
import sys

print("=" * 50)
print("DIAGN√ìSTICO DE VARIABLES DE ENTORNO")
print("=" * 50)

# Mostrar el directorio actual
current_dir = os.path.dirname(os.path.abspath(__file__))
print(f"Directorio actual: {current_dir}")

# Buscar el archivo .env
env_path = os.path.join(current_dir, '.env')
print(f"Buscando .env en: {env_path}")
print(f"¬øExiste el archivo?: {os.path.exists(env_path)}")

if os.path.exists(env_path):
    # Mostrar contenido del .env (sin contrase√±as)
    print("\nContenido del archivo .env:")
    with open(env_path, 'r') as f:
        for line in f:
            if line.strip() and not line.startswith('#'):
                key = line.split('=')[0]
                print(f"  - {key}")
    
    # Cargar el archivo .env
    load_dotenv(dotenv_path=env_path)
    print("\n‚úì Archivo .env cargado")
else:
    print("\n‚úó ERROR: Archivo .env NO encontrado")
    print("Crea un archivo .env en:", current_dir)
    sys.exit(1)

# Verificar variables despu√©s de cargar
print("\nVariables cargadas:")
database_url = os.getenv('DATABASE_URL') or os.getenv('SQLALCHEMY_DATABASE_URI')
secret_key = os.getenv('SECRET_KEY')

print(f"DATABASE_URL: {database_url[:30] + '...' if database_url else 'NO CARGADA'}")
print(f"SECRET_KEY: {secret_key if secret_key else 'NO CARGADA'}")
print("=" * 50)

if not database_url:
    print("\n‚úó ERROR: No se pudo cargar DATABASE_URL o SQLALCHEMY_DATABASE_URI")
    print("\nAseg√∫rate de que tu archivo .env contenga:")
    print("DATABASE_URL=postgresql://usuario:contrase√±a@localhost:5432/nombre_db")
    print("SECRET_KEY=tu_clave_secreta")
    sys.exit(1)

# Crear aplicaci√≥n Flask
app = Flask(__name__)

# Configuraci√≥n
app.config['SQLALCHEMY_DATABASE_URI'] = database_url
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.secret_key = secret_key

# Inicializar SQLAlchemy
db = SQLAlchemy(app)

# Importar modelos y rutas
try:
    from app.models import *
    print("‚úì Modelos importados correctamente")
except ImportError as e:
    print(f"‚ö† Advertencia: No se pudieron importar modelos - {e}")

try:
    from app.routes import *
    print("‚úì Rutas importadas correctamente")
except ImportError as e:
    print(f"‚ö† Advertencia: No se pudieron importar rutas - {e}")

if __name__ == '__main__':
    # Crear todas las tablas
    with app.app_context():
        try:
            db.create_all()
            print("=" * 50)
            print("‚úì Tablas creadas exitosamente")
            print("=" * 50)
        except Exception as e:
            print("=" * 50)
            print(f"‚úó Error al crear tablas: {e}")
            print("=" * 50)
    
    # Iniciar servidor
    print("\nüöÄ Servidor Flask iniciando en http://127.0.0.1:5000")
    print("Presiona CTRL+C para detener\n")
    app.run(debug=True, host='0.0.0.0', port=5000)


frontend

App.js

import './App.css';
import 'bootstrap/dist/css/bootstrap.min.css';
import SintomasForm from './components/SintomasForm';

function App() {
  return (
    <div className="App">
      <header className="App-header">
        <h1>Vigilancia Epidemiol√≥gica</h1>
        <SintomasForm />
      </header>
    </div>
  );
}

export default App;


SintomasForms.js

import React, { useState } from 'react';
import axios from 'axios';
import Button from 'react-bootstrap/Button';
import Form from 'react-bootstrap/Form';

const SintomasForm = () => {
  const [sintomas, setSintomas] = useState([]);
  const [resultado, setResultado] = useState(null);

  const handleCheckbox = (e) => {
    const value = e.target.value;
    setSintomas(prev => e.target.checked ? [...prev, value] : prev.filter(s => s !== value));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const res = await axios.post('http://localhost:5000/evaluar-sintomas', { sintomas });
      setResultado(res.data);
    } catch (error) {
      console.error(error);
    }
  };

  return (
    <div>
      <Form onSubmit={handleSubmit}>
        {/* Lista simple de s√≠ntomas - agrega m√°s seg√∫n necesites */}
        <Form.Check type="checkbox" label="Fiebre alta" value="fiebre_alta" onChange={handleCheckbox} />
        <Form.Check type="checkbox" label="Dolor de cabeza" value="dolor_cabeza" onChange={handleCheckbox} />
        <Form.Check type="checkbox" label="Erupciones" value="erupciones" onChange={handleCheckbox} />
        <Form.Check type="checkbox" label="Ictericia (piel amarilla)" value="ictericia" onChange={handleCheckbox} />
        {/* Agrega el resto: dolor_muscular, nauseas, etc. */}
        <Button type="submit">Evaluar</Button>
      </Form>
      {resultado && (
        <div>
          <p>Probabilidades: {JSON.stringify(resultado.probabilidades)}</p>
          <p>{resultado.advertencia}</p>
          {/* Bot√≥n para registrar: Implementa similar con POST a /registrar-caso, usa navigator.geolocation para lat/lon */}
        </div>
      )}
    </div>
  );
};

export default SintomasForm;








